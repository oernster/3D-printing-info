<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Printer Dashboard</title>
  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: 'Arial', sans-serif;
      background-color: transparent;
      color: #FFFFFF;

      /* Keep everything at the bottom of the window */
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      height: 100vh;
      box-sizing: border-box;
    }

    /* 3×3 grid: 9 items total */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 800px; /* optional cap on width */
    }

    .sensor {
      font-size: 18px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 5px;
      white-space: nowrap;
      text-align: left;
    }

    /* For temperature sensors: numeric is right-aligned, fixed min-width. */
    .temp-value {
      display: inline-block;
      min-width: 50px;
      text-align: right;
      color: orange;
    }

    /*
      For the fan sensor, we want the number right after "Part Cooling Fan:"
      without forcing alignment or extra spacing.
    */
    .fan-value {
      color: orange;
      /* no min-width or text-align, so it stays near the text */
      margin-left: 4px; /* small optional gap after the colon */
    }

    .progress-bar-container {
      width: 90%;
      margin-top: 10px;
      box-sizing: border-box;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #555;
      border-radius: 5px;
    }
    .progress {
	  height: 100%;
	  background: linear-gradient(
		to right,
		#ff0000 0%,
		#ffa500 25%,
		#ffff00 50%,
		#4caf50 100%
	  );
	  border-radius: 5px;
	  width: 0%;
	  transition: width 0.5s ease-in-out;
	  line-height: 20px;
	  text-align: center;
	  color: #0000ff; /* Blue text */
	  font-weight: bold; /* Make the text bold */
	}
  </style>
</head>
<body>

  <div class="dashboard">
    <div id="extruder" class="sensor">
      Extruder:
      <span class="temp-value">--</span>
      <span style="color:orange">°C</span>
    </div>
    <div id="heaterBed" class="sensor">
      Heater Bed:
      <span class="temp-value">--</span>
      <span style="color:orange">°C</span>
    </div>
    <div id="chamber" class="sensor">
      Chamber:
      <span class="temp-value">--</span>
      <span style="color:orange">°C</span>
    </div>
    <div id="mcu" class="sensor">
      MCU:
      <span class="temp-value">--</span>
      <span style="color:orange">°C</span>
    </div>
    <div id="internals" class="sensor">
      Internals:
      <span class="temp-value">--</span>
      <span style="color:orange">°C</span>
    </div>
    <div id="pi" class="sensor">
      Pi:
      <span class="temp-value">--</span>
      <span style="color:orange">°C</span>
    </div>
    <div id="nh36" class="sensor">
      NH36:
      <span class="temp-value">--</span>
      <span style="color:orange">°C</span>
    </div>
    <div id="cartographer" class="sensor">
      Cartographer:
      <span class="temp-value">--</span>
      <span style="color:orange">°C</span>
    </div>
    <!-- Fan sensor: no fixed width or right alignment on the value -->
    <div id="fan" class="sensor">
      Part Cooling Fan:
      <span class="fan-value">--</span>
      <span style="color:orange">%</span>
    </div>
  </div>

  <div class="progress-bar-container">
    <div class="progress-bar">
      <div id="progress" class="progress">0%</div>
    </div>
  </div>

  <script>
    async function fetchTemperatures() {
      try {
        const response = await fetch('/temperatures');
        const data = await response.json();

        document.getElementById('extruder').querySelector('.temp-value').textContent =
          data.Extruder.temperature ? parseFloat(data.Extruder.temperature).toFixed(2) : '--';
        document.getElementById('heaterBed').querySelector('.temp-value').textContent =
          data['Heater Bed'].temperature ? parseFloat(data['Heater Bed'].temperature).toFixed(2) : '--';
        document.getElementById('chamber').querySelector('.temp-value').textContent =
          data.CHAMBER.temperature ? parseFloat(data.CHAMBER.temperature).toFixed(2) : '--';
        document.getElementById('mcu').querySelector('.temp-value').textContent =
          data.MCU.temperature ? parseFloat(data.MCU.temperature).toFixed(2) : '--';
        document.getElementById('internals').querySelector('.temp-value').textContent =
          data.Internals.temperature ? parseFloat(data.Internals.temperature).toFixed(2) : '--';
        document.getElementById('pi').querySelector('.temp-value').textContent =
          data.Pi.temperature ? parseFloat(data.Pi.temperature).toFixed(2) : '--';
        document.getElementById('nh36').querySelector('.temp-value').textContent =
          data.NH36.temperature ? parseFloat(data.NH36.temperature).toFixed(2) : '--';
        document.getElementById('cartographer').querySelector('.temp-value').textContent =
          data.Cartographer.temperature ? parseFloat(data.Cartographer.temperature).toFixed(2) : '--';
      } catch (error) {
        console.error('Failed to fetch temperatures:', error);
      }
    }

    async function fetchProgress() {
      try {
        const response = await fetch('/progress');
        const data = await response.json();
        updateProgressBar(data.progress_percentage);
      } catch (error) {
        console.error('Failed to fetch progress:', error);
      }
    }

    function updateProgressBar(progress) {
      const progressBar = document.getElementById('progress');
      progressBar.style.width = progress + '%';
      progressBar.textContent = progress + '%';
    }

    // Fetch fan speed from /fan endpoint
    async function fetchFanSpeed() {
      try {
        const response = await fetch('/fan');
        const data = await response.json();
        document.getElementById('fan').querySelector('.fan-value').textContent =
          (data.fan_speed !== undefined) ? data.fan_speed.toFixed(1) : '--';
      } catch (error) {
        console.error('Failed to fetch fan data:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Initial fetch
      fetchTemperatures();
      fetchProgress();
      fetchFanSpeed();

      // Poll updates
      setInterval(fetchTemperatures, 12000);
      setInterval(fetchProgress, 3000);
      setInterval(fetchFanSpeed, 3000);
    });
  </script>
</body>
</html>
